## 会话技术

### 概念

**1、会话：**一次会话中包含多次请求和响应

-  一次会话：浏览器第一次给服务器资源发送请求，会话建立，直到有一方断开为止

**2、功能：**在一次会话的范围内的多次请求间，共享数据

<img src="https://gitee.com/panqiyi/pqimg/raw/master/20210320135119.png" alt="image-20210320135119169" style="zoom:67%;" />

**3、方式：**

​	1、客户端会话技术：Cookie

​	2、服务器端会话技术：Session



## Cookie

概念：客户端会话技术，将数据保存到客户端

Cookie 是服务器发送到用户浏览器并保存在本地的一小块数据，它会在浏览器之后向同一服务器再次发起请求时被携带上，用于告知服务端两个请求是否来自同一浏览器。由于之后每次请求都会需要携带 Cookie 数据，因此会带来额外的性能开销(尤其是在移动环境下)。

**功能：**

- 会话状态管理(如用户登录状态、购物车、游戏分数或其它需要记录的信息)
- 个性化设置(如用户自定义设置、主题等)
- 浏览器行为跟踪(如跟踪分析用户行为等)

**实现原理：**基于响应头set-cookie和请求头cookie实现

![image-20210329112546220](https://gitee.com/panqiyi/pqimg/raw/master/20210329112546.png)

### 快速入门：

```java
1、创建Cookie对象，绑定数据
    new  Cookie(String name,String value)
2、发送Cookie对象
	response.addCookie(Cookie cookie)
3、获取Cookie，拿到数据
	Cookie[]  request.getCookies()

//CookieDemo01
//1、创建Cookie对象
        Cookie cookie = new Cookie("lsp","hello");
        
        //2、发送Cookie
        response.addCookie(cookie);
//CookieDemo02 (与Demo01是同一个虚拟路径下)
//3、获取Co0kie
        Cookie[] cs = request.getCookies();
        //获取数据，遍历Cookies
        if (cs!= null){
            for (Cookie c : cs) {
                String name = c.getName();
                String value = c.getValue();
                System.out.println(name+":"+value);
            }
        }
```



### cookie的细节

**1、可不可以发送多个cookie?**

```
可以；
可以创建多个Cookie对象，使用response调用addCookie方法发送cookie即可
```

**2、cookie 在浏览器中保存多长时间？**

```
1、默认情况下，当浏览器关闭后，Cookie数据被销毁
2、持久化存储： 
		cookie对象.setMaxAge(int seconds)
	- 正数 ：将Cookie数据写到硬盘文件中，持久化存储。自定义cookie存活时间(如30，即30s)。
	- 负数 ：默认值
	- 零 ：删除cookie信息
```

**3、cookie能不能存中文？**

```
tomcat 8 之前cookie不能直接存储中文数据
	- 需要将中文数据转码 --- 一般采用URL编码
tomcat 8 后，cookie可以支持中文数据
(特殊符号不支持，如空格；使用URL编解码)
编码：URLEncoder.encode(string s,"utf-8");
解码：URLDecoder.decode(String s,"utf-8");
```

**4、cookie共享问题？**

1、假设一个tomcat服务器中，部署了多个web项目，那么在这些web项目中cookie能不能共享？

```
- 默认情况下cookie不能共享
- setPath(String path) : 设置cookie的获取范围。默认情况下，设置当前的虚拟目录
		- 如果要共享，则可以将path设置为 '/'
```

2、不同的tomcat服务器间cookie共享问题？

```
setDomain(String path) : 如果设置一级域名相同，那么多个服务器之间cookie可以共享
		- setDomain(".baidu.com"),那么tieba.baidu.com和news.baidu.com中cookie可以共享
```

**Cookie的特点和作用**

特点：

1、Cookie存储数据在客户端浏览器

3、相同name的cookie，后来者的value会覆盖前者

3、浏览器对于单个cookie的大小有限制(4kb,不同浏览器会有点差异)，对于同一个域名下的总cookie数量也有限制（20个，不同浏览器会有点差异）

作用：

1、cookie一般存储少量不太重要的数据

2、在不登录的情况下，完成服务器对客户端的身份识别等

​		- 如浏览器中的百度，设置用户自定义设置、主题等，无需登录，百度会根据浏览器的cookie信息反馈给服务器，然后给出对应资源

### 案例

记住上一次访问时间

1、需求

```
1、访问一个Servlet，如果是第一次访问，则提示：你好，欢迎您首次访问
2、如果不是第一次访问，则提示：欢迎回来，您上次访问时间为：显示时间字符串
```

2、分析

```
1、可以采用cookie来完成
2、在服务器的Servlet判断是否有一个名为lastTime的cookie
	1、有：不是第一次访问
	- 响应数据：欢迎回来，您上次访问时间为：2021年3月30日-10:01:20
	- 更新写回cookie：lastTime=当前这一次访问的时间
	2、没有：是第一次访问
	- 响应数据：您好，欢迎首次访问
	- 更新写回cookie: lastTime=2021年3月30日-10:01:20
```

代码：

```Java
//设置编码，防止中文乱码
response.setContentType("text/html;charset=utf-8");
//1、判断是否有名为lastTime的cookie
Cookie[] cookies = request.getCookies();
boolean flag=false; //没有lastTime
if (cookies!=null && cookies.length>0){
    for (Cookie cookie : cookies) {
        if ("lastTime".equals(cookie.getName())) {
            //1、有：不是第一次访问
            flag=true;
            //响应数据
            String value = cookie.getValue();
            response.getWriter().write("欢迎回来，您上一次访问时间为：" + value);

            //更新写回cookie时间
            Date date = new Date();
            SimpleDateFormat sdf = new SimpleDateFormat("yyyy年MM月dd日-HH:mm:ss");
            String str_date = sdf.format(date);
            cookie.setValue(str_date);
            //设置cookie存话时间
            cookie.setMaxAge(60 * 60 * 24 * 30); //一个月
            response.addCookie(cookie); //发送cookie
        }
    }
}

if (cookies==null || cookies.length==0 || flag==false){
    //没有lastTime，第一次访问
    //响应数据
    response.getWriter().write("您好，欢迎首次访问");

    //更新cookie
    Date date = new Date();
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy年MM月dd日-HH:mm:ss");
    String str_date = sdf.format(date);

    Cookie cookie = new Cookie("lastTime", str_date);
    cookie.setValue(str_date);
    //设置cookie存话时间
    cookie.setMaxAge(60 * 60 * 24 * 30); //一个月
    response.addCookie(cookie); //发送cookie

}
```



## JSP入门

### 概念

Java Servler Pages :  Java服务器端页面

	- 可以理解为一个特殊的页面，其中即可以指定html标签，又可以定义Java代码

### 原理

**jsp本质上就是一个Servlet**

运行tomcat，打开浏览器访问一个jsp文件，看控制台日志信息上面有如下一段

![image-20210330220437083](https://gitee.com/panqiyi/pqimg/raw/master/20210330220437.png)

复制该路径，文件打开

![image-20210330221004918](https://gitee.com/panqiyi/pqimg/raw/master/20210330221004.png)

即运行的jsp文件产生的资源

![image-20210330221127457](https://gitee.com/panqiyi/pqimg/raw/master/20210330221127.png)

由此可以看出：.jsp --> .java --> .class

打开.java文件查看代码：发现index_jsp类继承 HttpJspBase类

![image-20210330221503212](https://gitee.com/panqiyi/pqimg/raw/master/20210330221503.png)

而HttpJspBase类是由apache提供的，即tomcat提供的。

下面再看tomcat中HttpJspBase类，

![image-20210330221751916](https://gitee.com/panqiyi/pqimg/raw/master/20210330221751.png)

发现他继承自 HttpServlet, 所以说jsp本质上是一个Servlet

### 脚本

1、代码脚本

```
格式：<% Java语句 %>
作用：在JSP页面中可以编写需要的Java代码
```

2、表达式脚本

```
格式：<%=表达式 %>
作用：在浏览器的JSP页面上输出数据
```

3、声明脚本

```
格式：<%! 声明Java代码 %>
作用：可以给JSP翻译出来的Java类定义属性、方法、静态代码块、内部类等
```

### 内置对象

在jsp页面中不需要获取和创建，可以直接使用的对象、

jsp一共有9个内置对象。

先学3个：

- request

- response

- out : 字符串输出流对象。可以将数据输出到页面上。和response.getWriter()类似

   - response. getWriter() 和 out. writer() 的区别

     ​	在tomcat服务器真正给客户端做出响应之前，会先找response 缓冲区数据，再找out缓冲区数据。

     ​	所以response. getWriter() 会比 out. writer() 先输出，为了不影响布局，jsp会都选择用out. writer() 

## Session

### 概念

服务器端会话技术，在一次会话的多次请求间共享数据，将数据保存在服务器端的对象中。HttpSession

### 快速入门

1、获取HttpSession对象：

```java 
HttpSession  session = request.getSession();
```

2、使用HttpSession对象

```
Object  getAttribute(String name) : 据名取值
void  setAttribute(String name,Object value) : 设置Session
void  removeAttribute(String name) : 删除Session
```



```java
// session01
//获取 Session 对象
HttpSession session = request.getSession();
//设置Session
session.setAttribute("lsp","java");

// session02
HttpSession session = request.getSession();
        Object lsp = session.getAttribute("lsp");
        System.out.println(lsp);
```



### 原理

Session的实现原理是依赖与Cookie的

![image-20210331171353792](https://gitee.com/panqiyi/pqimg/raw/master/20210331171353.png)



### 细节

**1、当客户端关闭，服务器不关闭，两次获取session 是否为同一个？**

```Java
- 默认情况下，不是
- 如果需要相同，可以创建Cookie,键为JSESSIONID，设置最大存活时间，让cookie持久化保存。
如：
//获取 Session 对象
        HttpSession session = request.getSession();

        Cookie cookie = new Cookie("JSESSIONID", session.getId()); //新建cookie
        cookie.setMaxAge(60*60); //持久化保存
        response.addCookie(cookie); // 发送cookie
```

**2、客户端不关闭，服务器关闭后，两次获取的session是同一个吗？**

```
- 不是同一个，但是要确保数据不丢失
		- session的钝化：
			在服务器正常关闭之前，将session对象序列化到硬盘上
		- session的活化：
			在服务器启动后，将session文件转化为内存中的session对象即可
```

<font color='orange'>session钝化/活化 -- Tomcat自动完成（idea无法完成）：</font>

​	1- 将项目的out目录下的部署文件复制一份，压缩为.zip --- 改后缀名为 .war

​													idea：		![image-20210413153518300](https://gitee.com/panqiyi/pqimg/raw/master/20210413153518.png)

![image-20210413153640413](https://gitee.com/panqiyi/pqimg/raw/master/20210413153640.png)

![image-20210413153745279](https://gitee.com/panqiyi/pqimg/raw/master/20210413153745.png)

![image-20210413154010263](https://gitee.com/panqiyi/pqimg/raw/master/20210413154010.png)

桌面打开复制来的文件夹

<img src="https://gitee.com/panqiyi/pqimg/raw/master/20210413154242.png" alt="image-20210413154242231" style="zoom:80%;" />

<img src="https://gitee.com/panqiyi/pqimg/raw/master/20210413154437.png" alt="image-20210413154437383" style="zoom:80%;" />

<img src="https://gitee.com/panqiyi/pqimg/raw/master/20210413154608.png" alt="image-20210413154608109" style="zoom:80%;" />

![image-20210413154708494](https://gitee.com/panqiyi/pqimg/raw/master/20210413154708.png)

将day01.war复制粘贴到tomcat的webapps目录中：

![image-20210413154915810](https://gitee.com/panqiyi/pqimg/raw/master/20210413154915.png)

到tomcat的bin目录中启动tomcat，发现day01项目已经被自动部署

<img src="https://gitee.com/panqiyi/pqimg/raw/master/20210413155217.png" alt="image-20210413155217523" style="zoom:80%;" />

此时即可访问day01下的项目，关闭服务器，再次打开访问也能访问到

<font color=red>实现原理：</font>靠tomcat的work目录

![image-20210413160014385](https://gitee.com/panqiyi/pqimg/raw/master/20210413160014.png)

work目录：存储程序运行时动态生成的数据，如jps转换的java文件，session序列化文件

​		正常关闭tomcat后，在work中可看到day01项目的session对象

![image-20210413160409475](https://gitee.com/panqiyi/pqimg/raw/master/20210413160409.png)

​		启动服务器后，该session对象会被自动读取

![image-20210413160750781](https://gitee.com/panqiyi/pqimg/raw/master/20210413160750.png)

<font color='red'>为什么idea不能自动钝化/活化session对象？</font>

因为idea的work文件，在idea中启动服务器时会自动删除work目录再生成新的work目录。

**3、session什么时候被销毁？**

​	1、服务器关闭

​	2、session对象调用 invalidate() 方法

​	3、session默认失效时间 30分钟

```xml
选择性配置修改：tomcat目录下-->conf-->web.xml
<session-config>
        <session-timeout>30</session-timeout>
   </session-config>
```



### 特点

session的特点：

1、session用于存储一次会话的多次请求的数据，存在服务器端

2、session可以存储任意类型，任意大小的数据

session与Cookie的区别：

​	1、session存储数据在服务器端，cookie存储在客户端

​	2、session没有大小限制，cookie有

​	3、session数据安全，cookie相对不安全



### 案例：登录(验证码)

1、案例需求：

​	1、访问带有验证码的登录页面login.jsp

​	2、用户输入用户名，密码以及验证码。

		- 如果用户名和密码输入有误，跳转登录页面，提示：用户名或者密码错误 
		- 如果验证码输入有误，跳转登录页面，提示：验证码错误
		- 如果全部输入正确，则跳转到主页success.jsp，显示：用户名，欢迎您

![image-20210413195437885](https://gitee.com/panqiyi/pqimg/raw/master/20210413195437.png)

![image-20210418224303163](https://gitee.com/panqiyi/pqimg/raw/master/20210418224303.png)

<img src="https://gitee.com/panqiyi/pqimg/raw/master/20210418220139.png" alt="image-20210418220139009" style="zoom:80%;" />

![image-20210418220428226](https://gitee.com/panqiyi/pqimg/raw/master/20210418220428.png)

login.jsp：

```jsp
inServlet" method="post">
<table>
    <tr>
        <td>用户名</td>
        <td><input type="text" name="username"></td>
    </tr>
    <tr>
        <td>密码</td>
        <td><input type="password" name="password"></td>
    </tr>
    <tr>
        <td>验证码</td>
        <td><input type="text" name="checkcode"></td>
    </tr>
    <tr>
        <td colspan="2"><img id="img" src="/pqy1/checkcode"></td>
    </tr>
    <tr>
        <td colspan="2"><input type="submit" value="登录"></td>
    </tr>
</table>
</form>
<div><%=request.getAttribute("check_error")==null?"":request.getAttribute("check_error")%></div>
<div><%=request.getAttribute("login_error")==null?"":request.getAttribute("login_error")%></div>
</body>
</html>
```

LoignServelt：

```java
package servlet;

import cn.pqy.dao.User;
import cn.pqy.domain.UserDao;
import org.apache.commons.beanutils.BeanUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.util.Map;

/**
 * @author panqiyi
 * @date 2021/4/17 - 23:56
 */
@WebServlet("/loginServlet")
public class LoginServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        //设置request编码
        request.setCharacterEncoding("utf-8");
        //创建User对象
        User user = new User();
        //获取请求头map集合
        Map<String, String[]> map = request.getParameterMap();
        //封装userbean（使用BeanUtils工具类），即从用户在网页输入的信息赋值给user
        try {
            BeanUtils.populate(user,map);
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        } catch (InvocationTargetException e) {
            e.printStackTrace();
        }
        //创建操作数据库UserDao对象，返回user对象，不为null则登录成功，否则失败
        UserDao userDao = new UserDao();
        User loginUser = userDao.login(user);  //通过数据库查询后，返回的user对象：loginUser

        //判断验证码是否正确, 通过session获取随机生成的验证码
        HttpSession session = request.getSession();
        String checkcode_session = (String) session.getAttribute("checkcode_session");
        //删除session存储的验证码，保证验证码为一次性
        session.removeAttribute("checkcode_session");

        if (checkcode_session!=null && checkcode_session.equalsIgnoreCase(user.getCheckcode())){ //equalsIgnoreCase比较字符串忽略大小写
            //随机生成与用户输入的验证码一样，正确。
            //判断用户和密码是否正确
            if (loginUser!=null){
                //存储用户名到session
                session.setAttribute("user",user.getUsername());
                //重定向到登录成功页面
                response.sendRedirect(request.getContextPath()+"/success.jsp"); //request.getContextPath() : 动态获取虚拟路径
            }else {
                //用户名或者密码错误
                //存储提示信息到request
                request.setAttribute("login_error","用户名或密码错误！");
                //跳转到登录页面
                request.getRequestDispatcher("login.jsp").forward(request,response);
            }
        }else {
            //验证码有误
            //存储提示信息到request
            request.setAttribute("check_error","验证码错误！");
            //转发到登录页面
            request.getRequestDispatcher("login.jsp").forward(request,response);
        }



    }

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        this.doPost(request, response);
    }
}
```

CheckcodeServlet：

```Java
package servlet;

import javax.imageio.ImageIO;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.IOException;
import java.util.Random;

/**
 * @author panqiyi
 * @date 2021/4/13 - 20:02
 */
@WebServlet("/checkcode")
public class CheckcodeServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        int width = 100;
        int height = 50;

//1.创建一对象，在内存中图片(验证码图片对象)
        BufferedImage image = new BufferedImage(width,height,BufferedImage.TYPE_INT_RGB);


//2.美化图片
//2.1 填充背景色
        Graphics g = image.getGraphics();//画笔对象
        g.setColor(Color.PINK);//设置画笔颜色
        g.fillRect(0,0,width,height);

//2.2画边框
        g.setColor(Color.BLUE);
        g.drawRect(0,0,width - 1,height - 1);

        String str = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghigklmnopqrstuvwxyz0123456789";
//生成随机角标
        Random ran = new Random();

        StringBuilder strb = new StringBuilder(); //新建StringBuilder 对象
        for (int i = 1; i <= 4; i++) {
            int index = ran.nextInt(str.length()-1);
            //获取字符
            char ch = str.charAt(index);//随机字符
            //将字符添加到strb对象中
            strb.append(ch);
            //2.3写验证码
            g.drawString(ch+"",width/5*i,height/2);
        }
        String checkcode_session = strb.toString(); //转换为String对象
        //存储到session中
        HttpSession session = request.getSession();
        session.setAttribute("checkcode_session",checkcode_session);


//2.4画干扰线
        g.setColor(Color.GREEN);

//随机生成坐标点

        for (int i = 0; i < 10; i++) {
            int x1 = ran.nextInt(width);
            int x2 = ran.nextInt(width);

            int y1 = ran.nextInt(height);
            int y2 = ran.nextInt(height);
            g.drawLine(x1,y1,x2,y2);
        }


//3.将图片输出到页面展示
        ImageIO.write(image,"jpg",response.getOutputStream());
    }

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        this.doPost(request, response);
    }
}
```

User：

```java
public class User { //javaBean类
    private String username;
    private String password;
    private String checkcode;
    //省略get/set和重写toString()
    }
```

UserDao：

```Java
import cn.pqy.dao.User;
import cn.pqy.util.JdbcUtil;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.BeanPropertyRowMapper;
import org.springframework.jdbc.core.JdbcTemplate;

import javax.jws.soap.SOAPBinding;

/**
 * @author panqiyi
 * @date 2021/4/18 - 0:12
 */
public class UserDao { //操作数据库的类
    //公共的 Spring template对象
   private JdbcTemplate template=new JdbcTemplate(JdbcUtil.getDataSource());

   public User login(User loginUser){
       try {
           String sql="select * from user where username=? and password=?";
           User user=template.queryForObject(sql,
                   new BeanPropertyRowMapper<User>(User.class), // 自动将属性对应bean成员变量，封装为bean对象
                   loginUser.getUsername(), //给？赋值
                   loginUser.getPassword());
           return user; //在数据库中找到则返回查找到的user对象，即返回后包含了对应bean成员变量的所有信息
       } catch (DataAccessException e) {
           e.printStackTrace();
           return null; //数据库则没有返回null
       }
   }

}
```

 mysql数据库：

```sql
CREATE DATABASE db4;

CREATE TABLE USER(
	id INT PRIMARY KEY AUTO_INCREMENT, -- id
	username VARCHAR(32) UNIQUE NOT NULL, -- 用户名
	PASSWORD VARCHAR(32) NOT NULL, -- 密码
	hobby VARCHAR(32) -- 爱好
);

INSERT INTO USER VALUES(NULL,"笑春风","123","篮球");
```

